<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cxyz.check.dao.RecordDao">

    <resultMap id="test" type="CheckHistoryDto">
        <id column="id" property="id" />
        <result column="taskName" property="taskName" />
        <result column="state" property="state"/>
        <result column="commitTime" property="commitTime" />
        <collection property="results" ofType="ResultCustom">
            <result property="resultType" column="results.resultType" />
            <result property="count" column="results.count" />
        </collection>
    </resultMap>

    <select id="getCheckRecords" resultType="CheckRecord" >
      select
      r.`completion.id`,
      r.des,
      r.result,
      c.update_time 'completion.updateTime'
      from tb_record r,tb_completion c
      where r.`stu.id` = #{id}
      and c.id=r.`completion.id`
      order by r.id desc
      limit #{start},#{len}
    </select>

    <!--批处理添加纪录到tb_record表中-->
    <insert id="addRecords" >
        insert into tb_record(`completion.id`,`stu.id`,des,result)
        values
        <foreach collection="stuInfo" item="item" close=";" separator=",">
            (#{id},#{item.id},#{item.des},#{item.result})
        </foreach>
    </insert>

    <insert id="addOtherState">
        insert into tb_otherstate(`completion.id`,des)
        VALUES (#{id},#{des});
    </insert>

    <select id="getHistory" resultMap="test" >
     SELECT
     s.id,
     s.name 'taskName',
     s.state,
     m.name, 'roomName',
     s.update_time 'commitTime',
     r.result 'results.resultType',
     count(*) 'results.count'
     FROM tb_record r Inner JOIN (SELECT c.id,t.name,c.state,c.update_time,t.`room.id` FROM tb_completion c,tb_taskinfo t
     WHERE t.`checker.id`=#{id}
     AND t.`checker.type`=#{type}
     AND t.id = c.`taskinfo.id`
     AND c.state != 0
     ORDER BY c.update_time DESC limit #{start},#{len}) s on s.id = r.`completion.id` LEFT JOIN tb_room m on s.`room.id`=r.id
     GROUP BY s.id,s.name,s.state,r.result,s.update_time,m.name
    </select>


</mapper>