<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cxyz.check.dao.TaskDao">

    <resultMap id="TaskInfoMap" type="TaskInfo">
        <id property="name" column="name" />
        <association property="sponsor"
            column="{id=sponsor.id,type=sponsor.type}"
            javaType="User"
            select="com.cxyz.check.dao.UserDao.selectOne" />
        <collection column="{taskId=id,state=state}" property="completions"
            ofType="TaskCompletion" javaType="java.util.ArrayList"
            select="com.cxyz.check.dao.TaskCompletionDao.findByTaskId" />
    </resultMap>

    <select id="getSubjects" resultMap="TaskInfoMap">
        SELECT
        t.id,
        t.name,
        t.`room.id`,
        t.`sponsor.id`,
        t.start 'start.id',
        c.week,
        t.end 'end.id',
        t.`sponsor.type`,
        t.weekday
        FROM tb_taskinfo t,tb_completion c
        WHERE t.id=c.`taskinfo.id`
        AND t.`grade.id`=#{gradeId}
        AND t.`term.id`=#{termId}
        AND t.type=1
    </select>


    <select id="checkTask" resultType="TaskCompletion" >
        select
        c.id,
        t.`name` 'taskInfo.name',
        t.`sponsor.id` 'taskInfo.sponsor.id',
        t.`startTime` 'taskInfo.start.start',
        t.`endTime` 'taskInfo.end.end',
        t.`sponsor.type` 'taskInfo.sponsor.type',
        t.type 'taskInfo.type',
        r.`name` 'taskInfo.room.name'
        from tb_completion c,tb_taskinfo t LEFT JOIN tb_room r ON t.`room.id` = r.id
        where t.`checker.id`=#{checkerId}
        and t.`checker.type`=#{checkerType}
        and t.id = c.`taskinfo.id`
        and c.date = #{date}
        and t.type=#{type}
        and #{time} &lt;= t.`endTime`
        and #{time} &gt;= t.`startTime`
        and c.state=0
    </select>

    <select id="getCompDate" resultType="java.util.Date">
        SELECT
        `update_time`
        FROM tb_completion
        WHERE id=#{id};
    </select>

    <select id="getGradeCheck" resultType="Integer">
        SELECT
        count(*)
        FROM tb_completion c,tb_taskinfo t
        WHERE c.`taskinfo.id`=t.id
        and t.`grade.id`=#{grade}
        and c.state=1;
    </select>


    <insert id="addTask" parameterType="TaskInfo" keyProperty="task.id" useGeneratedKeys="true">
        INSERT INTO
        tb_taskinfo(name,`sponsor.id`,`sponsor.type`,`checker.id`,`checker.type`,
        `type`,`grade.id`,`room.id`,weekday,start,end,`term.id`,startTime,endTime)
        VALUES(#{task.name},#{task.sponsor.id},#{task.sponsor.type},#{task.checker.id},#{task.checker.type},#{type},
        #{gradeId},#{task.room.id},#{task.weekday},#{task.start.id},#{task.end.id},#{termId},
        #{task.start.start},#{task.end.end})
    </insert>

    <select id="getTaskInfos" resultMap="TaskInfoMap">
        SELECT
        *,
        1 'state'
        FROM
        tb_taskinfo
        WHERE `grade.id`=#{gradeId}
        AND name=#{taskName}
        AND `sponsor.id`=#{sponsorId}
        AND `sponsor.type`=#{sponsorType}
    </select>


</mapper>