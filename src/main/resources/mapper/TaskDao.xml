<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cxyz.check.dao.TaskDao">

    <select id="checkTask" resultType="TaskCompletion" >
        select
        c.id,
        t.`name` 'taskInfo.name',
        t.`sponsor.id` 'taskInfo.sponsor.id',
        s.`start` 'start',
		e.`end` 'end',
        t.`sponsor.type` 'taskInfo.sponsor.type',
        t.type 'taskInfo.type',
		r.`name` 'taskInfo.room.name'
        from tb_completion c,tb_taskinfo t,tb_times s,tb_times e,tb_room r,tb_term m
        where t.`checker.id`=#{checker_id}
        and t.`checker.type`=#{checker_type}
        and t.id = c.`taskinfo.id`
        and t.`start` = s.`session`
		and t.`end` = e.`session`
        and t.`term.id` = s.`term.id`
		and t.`room.id` = r.id
		and t.`term.id` = e.`term.id`
		and t.`term.id` = m.id
		and DATE_ADD(m.`begin`,INTERVAL ((c.`week`-1)*7+(DAYOFWEEK(m.`begin`)+5)%7) DAY) = #{date}
        and t.type=#{type}
        and #{time} &lt;= e.`end`
        and #{time} &gt;= s.`start`
        and c.state=0
    </select>

    <update id="updateComp" >
        update tb_completion
        set state=#{state},
        update_time=now()
        where id=#{id};
    </update>

    <select id="getCompDate" resultType="java.util.Date">
        SELECT
        `update_time`
        FROM tb_completion
        WHERE id=#{id};
    </select>

    <select id="getGradeCheck" resultType="Integer">
        SELECT
        count(*)
        FROM tb_completion c,tb_taskinfo t
        WHERE c.`taskinfo.id`=t.id
        and t.`grade.id`=#{grade}
        and c.state=1;
    </select>

    <insert id="addComp">
        insert into tb_completion(`date`,`taskinfo.id`)
        values(#{date},#{id});
    </insert>

    <insert id="addTask" parameterType="TaskInfo" keyProperty="task.id" useGeneratedKeys="true">
        INSERT INTO
        tb_taskinfo(name,`sponsor.id`,`sponsor.type`,`checker.id`,`checker.type`,
        `type`,`grade.id`,`room.id`,weekday,start,end,`term.id`)
        VALUES(#{task.name},#{task.sponsor.id},#{task.sponsor.type},#{task.checker.id},#{task.checker.type},#{type},
        #{gradeId},#{task.room.id},#{task.weekday},#{task.start},#{task.end},#{termId})
    </insert>
</mapper>