<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cxyz.check.dao.TaskDao">

    <resultMap id="GradeLessonDtoMap" type="GradeLessonDto" autoMapping="true">
        <id column="id" property="gradeId" />
        <result property="gradeName" column="name" />
        <collection property="lessons" javaType="java.util.ArrayList" ofType="LessonDto" autoMapping="true">
            <id property="id" column="lessonId" />
            <result property="name" column="lessonName" />
        </collection>
    </resultMap>


    <resultMap id="SubjectTaskInfoMap" type="TaskInfo" autoMapping="true">
        <id property="id" column="id" />
        <association property="sponsor.name"
            column="{id=sponsor.id,type=sponsor.type}"
            javaType="User"
            select="com.cxyz.check.dao.UserDao.getName" />
        <collection property="completions" javaType="java.util.ArrayList" ofType="TaskCompletion" >
            <result column="week" property="week"/>
        </collection>
    </resultMap>

    <resultMap id="TaskMap" type="Task" autoMapping="true">
        <id column="id" property="id"></id>
        <collection column="{taskId=id,state=state}" property="completions"
            ofType="TaskCompletion" javaType="java.util.ArrayList"
            select="com.cxyz.check.dao.TaskCompletionDao.findByTaskId" />
    </resultMap>

    <select id="getSubjects" resultMap="SubjectTaskInfoMap">
        SELECT
        t.id,
        t.name,
        t.`room.id`,
        t.`sponsor.id`,
        t.start 'start.id',
        c.week,
        t.end 'end.id',
        t.`sponsor.type`,
        t.weekday
        FROM taskinfo t,tb_completion c
        WHERE t.id=c.`taskinfo.id`
        AND t.`grade.id`=#{gradeId}
        AND t.`term.id`=#{termId}
        AND t.type=1
    </select>


    <select id="checkTask" resultType="TaskCompletion" >
        select
        c.id,
        t.`name` 'taskInfo.name',
        t.`sponsor.id` 'taskInfo.sponsor.id',
        t.`startTime` 'taskInfo.start.start',
        t.`endTime` 'taskInfo.end.end',
        t.`sponsor.type` 'taskInfo.sponsor.type',
        t.type 'taskInfo.type',
        r.`name` 'taskInfo.room.name'
        from tb_completion c,taskinfo t LEFT JOIN tb_room r ON t.`room.id` = r.id
        where t.`checker.id`=#{checkerId}
        and t.`checker.type`=#{checkerType}
        and t.id = c.`taskinfo.id`
        and c.date = #{date}
        and t.type=#{type}
        and #{time} &lt;= t.`endTime`
        and #{time} &gt;= t.`startTime`
        and c.state=0
    </select>

    <select id="getCompDate" resultType="java.util.Date">
        SELECT
        `update_time`
        FROM tb_completion
        WHERE id=#{id};
    </select>

    <select id="getGradeCheck" resultType="Integer">
        SELECT
        count(*)
        FROM tb_completion c,taskinfo t
        WHERE c.`taskinfo.id`=t.id
        and t.`grade.id`=#{grade}
        and c.state=1;
    </select>


    <insert id="addTask" parameterType="TaskInfo" keyProperty="task.id" useGeneratedKeys="true">
        INSERT INTO
        tb_task(`lesson.id`,weekday,start,
        end,startTime,endTime)
        VALUES(#{task.lesson.id},#{task.weekday},#{task.start.id},
        #{task.end.id},#{task.start.start},#{task.end.end})
    </insert>

    <select id="getTasks" resultMap="TaskMap">
        SELECT
        *,
        1 'state'
        FROM
        tb_task
        WHERE `lesson.id`=#{lessonId}
    </select>

    <select id="getGradeTasks" resultMap="GradeLessonDtoMap">
        SELECT
        t.id 'lessonId',
        t.`checker.id` 'checkerId',
        t.`checker.type` 'checkerType',
        g.id,
        g.name,
        t.`room.id` 'roomId',
        r.name 'roomName',
        t.num,
        t.name 'lessonName'
        FROM tb_grade g,tb_lesson t
        LEFT JOIN tb_room r ON t.`room.id`=r.id
        WHERE g.id = t.`grade.id`
        AND t.`sponsor.id`=#{sponsorId}
        AND t.`sponsor.type`=#{sponsorType}
        <if test="termId!=null">
            AND t.`term.id`=#{termId}
        </if>
    </select>


</mapper>